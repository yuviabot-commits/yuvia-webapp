<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>YuviaBot Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map { width:100%; height:100%; margin:0; padding:0; }

    /* –û–≤–µ—Ä–ª–µ–π-–ø–æ–¥—Å–∫–∞–∑–∫–∞ */
    #hint {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.6); z-index: 99999;
    }
    #hint .box {
      max-width: 92%; background: #111; color:#fff;
      border-radius:14px; padding:16px;
      font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    #hint .box h3 { margin:0 0 8px; font-size:16px }
    #hint .btn {
      margin-top:12px; width:100%; border:0; border-radius:10px; padding:10px 14px;
      background:#2ea6ff; color:#fff; font-weight:600; font-size:15px; cursor:pointer;
    }

    /* –ö–Ω–æ–ø–∫–∞ ¬´?¬ª (—Ä—É—á–Ω–æ–π –≤—ã–∑–æ–≤ –ø–æ–¥—Å–∫–∞–∑–∫–∏) */
    #helpBtn {
      position:fixed; right:10px; top:10px; z-index:9999;
      background:#111; color:#fff; border:0; border-radius:10px;
      padding:8px 11px; font-weight:700; cursor:pointer; opacity:.9;
    }
  </style>

  <!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=f08ffb69-0b44-40a1-a11c-4980f7e574b6"></script>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="map"></div>

  <!-- –ö–Ω–æ–ø–∫–∞ ¬´?¬ª -->
  <button id="helpBtn">?</button>

  <!-- –û–≤–µ—Ä–ª–µ–π-–ø–æ–¥—Å–∫–∞–∑–∫–∞ -->
  <div id="hint">
    <div class="box">
      <h3>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞—Ä—Ç–æ–π</h3>
      <div>
        1) –ù–∞–π–¥–∏ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏–ª–∏ —Ç–∫–Ω–∏ –µ—ë –Ω–∞ –∫–∞—Ä—Ç–µ.<br/>
        2) –ù–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ¬ª ‚Äî —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –º–∏–Ω–∏-—ç–∫—Å–∫—É—Ä—Å–∏—é üéß
      </div>
      <button class="btn" id="hintOk">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script>
    // === Telegram ===
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();

    // === –ü—Ä–æ–∫—Å–∏ (Cloudflare Worker) ‚Üí GAS ===
    const PROXY_URL = "https://yuvia-proxy.yuviabot.workers.dev/";
    const BOT_SECRET = "8d7f3f2e2a6d44b5aeb4caa7f924c8f9";

    // === user_id –∏–∑ ?id= (–∏–ª–∏ –∏–∑ initData) ===
    function getUserId() {
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get("id") || qs.get("user_id") || qs.get("contact_id");
      if (fromQS) return String(fromQS);
      try { const fromTG = tg?.initDataUnsafe?.user?.id; if (fromTG) return String(fromTG); } catch(_) {}
      return "";
    }

    // ===== –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–∫–∞–∑–∞
    const hint       = document.getElementById('hint');
    const hintOk     = document.getElementById('hintOk');
    const helpBtn    = document.getElementById('helpBtn');

    // –º–µ–Ω—è–π –≤–µ—Ä—Å–∏—é, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏—à—å —Ç–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏
    const HINT_VER           = 'v3';
    const KEY_LAST_SHOWN     = 'yuvia_hint_last_' + HINT_VER; // –¥–∞—Ç–∞ 'YYYY-MM-DD'
    const KEY_FAILS          = 'yuvia_hint_fails_' + HINT_VER;
    const FAILS_THRESHOLD    = 2;   // –ø–æ–∫–∞–∑–∞—Ç—å —Å–Ω–æ–≤–∞, –µ—Å–ª–∏ 1‚Äì2 —Ä–∞–∑–∞ –∑–∞–∫—Ä—ã–ª–∏ –±–µ–∑ –≤—ã–±–æ—Ä–∞
    const NO_SELECT_TIMEOUT  = 15000; // 15 —Å–µ–∫ –±–µ–∑ –≤—ã–±–æ—Ä–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º "–Ω–µ—É–¥–∞—á–∞"

    function todayStr() {
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return d.getFullYear() + '-' + m + '-' + day;
    }
    function getInt(k){ return Number(localStorage.getItem(k) || 0); }
    function setInt(k,v){ localStorage.setItem(k, String(v)); }

    function shouldShowHint() {
      const last = localStorage.getItem(KEY_LAST_SHOWN);
      const fails = getInt(KEY_FAILS);

      // 1) –°–∞–º—ã–π –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å
      if (!last) return true;

      // 2) –ü–æ–≤—Ç–æ—Ä—è—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (last !== todayStr()) return true;

      // 3) –ï—Å–ª–∏ 1‚Äì2 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–¥—Ä—è–¥ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å
      if (fails >= FAILS_THRESHOLD) return true;

      return false;
    }

    function markHintShownToday() {
      localStorage.setItem(KEY_LAST_SHOWN, todayStr());
      // –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ—É–¥–∞—á–∏
      localStorage.removeItem(KEY_FAILS);
    }

    function incFail() { setInt(KEY_FAILS, getInt(KEY_FAILS) + 1); }
    function resetFails(){ localStorage.removeItem(KEY_FAILS); }

    function openHint(){ hint.style.display = 'flex'; }
    function closeHint(){ hint.style.display = 'none'; markHintShownToday(); }

    if (shouldShowHint()) openHint();
    hintOk.onclick = closeHint;
    helpBtn.onclick = openHint;

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª WebApp (—É—à—ë–ª —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) –±–µ–∑ –≤—ã–±–æ—Ä–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º "–Ω–µ—É–¥–∞—á–∞"
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && !selectedPlace) incFail();
    });

    // –ï—Å–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî —Ç–æ–∂–µ "–Ω–µ—É–¥–∞—á–∞"
    setTimeout(() => { if (!window.selectedPlace) incFail(); }, NO_SELECT_TIMEOUT);

    // ===== –ö–∞—Ä—Ç–∞
    let map, selectedPlace = null, mainBound = false;

    ymaps.ready(() => {
      map = new ymaps.Map("map", { center: [55.751244, 37.618423], zoom: 12, controls: [] });

      const searchControl = new ymaps.control.SearchControl({ provider: 'yandex#search' });
      map.controls.add(searchControl);

      // –¶–µ–Ω—Ç—Ä –ø–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –¥–∞—Å—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
      try {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => { map.setCenter([pos.coords.latitude, pos.coords.longitude], 13); },
            _err => {}, { enableHighAccuracy: true, timeout: 3000 }
          );
        }
      } catch(_) {}

      // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
      map.events.add("click", (e) => {
        const c = e.get("coords");
        selectedPlace = { name: "–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ", address: "", lat: c[0], lon: c[1] };
        redraw(c, selectedPlace.name);
        ensureMainButton();
      });

      // –í—ã–±–æ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞
      searchControl.events.add("resultselect", (e) => {
        const i = e.get("index");
        const res = searchControl.getResultsArray();
        const obj = res[i];
        if (!obj) return;
        const c = obj.geometry.getCoordinates();
        selectedPlace = {
          name: obj.properties.get("name") || "–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ",
          address: obj.properties.get("description") || "",
          lat: c[0], lon: c[1]
        };
        redraw(c, selectedPlace.name);
        ensureMainButton();
      });
    });

    function redraw(coords, balloon) {
      map.geoObjects.removeAll();
      map.geoObjects.add(new ymaps.Placemark(coords, { balloonContent: balloon || "" }));
    }

    function ensureMainButton() {
      tg.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ");
      tg.MainButton.show(); tg.MainButton.enable();
      if (!mainBound) { mainBound = true; Telegram.WebApp.MainButton.onClick(onChoose); }
    }

    function onChoose() {
      const uid = getUserId();
      if (!uid) { try { tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id. –û—Ç–∫—Ä–æ–π —Å—Å—ã–ª–∫—É —Å ?id={{id}}"); } catch(_) {} return; }
      if (!selectedPlace) { try { tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ"); } catch(_) {} return; }

      // —É—Å–ø–µ—Ö ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á
      resetFails();

      const payload = {
        secret: BOT_SECRET, action: "save_place", user_id: uid,
        title: selectedPlace.name || "", address: selectedPlace.address || "",
        lat: String(selectedPlace.lat || ""), lon: String(selectedPlace.lon || ""),
        ts: String(Date.now())
      };

      // –ù–∞–¥—ë–∂–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞: GET-–ø–∏–∫—Å–µ–ª—å –Ω–∞ –ø—Ä–æ–∫—Å–∏
      const qs = new URLSearchParams(payload);
      (new Image()).src = PROXY_URL + "?" + qs.toString();

      setTimeout(() => { try { tg.close(); } catch(_) {} }, 300);
    }
  </script>
</body>
</html>


