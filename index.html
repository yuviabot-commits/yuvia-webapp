<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>YuviaBot ‚Ä¢ –ö–∞—Ä—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map { width:100%; height:100%; margin:0; padding:0; background:#0e0e0e; }
    /* –û–≤–µ—Ä–ª–µ–π-–ø–æ–¥—Å–∫–∞–∑–∫–∞ */
    #hint {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.55); z-index: 99999;
    }
    #hint .box {
      max-width: 92%; background: #141414; color:#fff;
      border-radius:14px; padding:16px 16px 14px;
      font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.06);
    }
    #hint .box h3 { margin:0 0 8px; font-size:16px }
    #hint .btn {
      margin-top:12px; width:100%; border:0; border-radius:10px; padding:10px 14px;
      background:#2ea6ff; color:#fff; font-weight:600; font-size:15px; cursor:pointer;
    }
  </style>

  <!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=f08ffb69-0b44-40a1-a11c-4980f7e574b6"></script>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="map"></div>

  <!-- –û–≤–µ—Ä–ª–µ–π-–ø–æ–¥—Å–∫–∞–∑–∫–∞ (–æ—Å—Ç–∞–≤–∏–ª–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
  <div id="hint">
    <div class="box">
      <h3>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞—Ä—Ç–æ–π</h3>
      <div>
        1) –ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É.<br/>
        2) –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ¬ª ‚Äî –±–æ—Ç –ø—Ä–∏—à–ª—ë—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Å —Å—Å—ã–ª–∫–∞–º–∏ üéß
      </div>
      <button class="btn" id="hintOk">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script>
    /* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===== */
    const PROXY_URL  = "https://yuvia-proxy.yuviabot.workers.dev/"; // –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π Worker
    const BOT_SECRET = "8d7f3f2e2a6d44b5aeb4caa7f924c8f9";           // –∫–∞–∫ –≤ GAS

    /* ===== Telegram WebApp ===== */
    const tg = window.Telegram.WebApp; try { tg.expand(); tg.ready(); } catch(_){}

    /* ===== user_id –∏ sid ===== */
    function getUserId(){
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get("id") || qs.get("user_id") || qs.get("contact_id");
      if (fromQS) return String(fromQS);
      try { const u = tg?.initDataUnsafe?.user?.id; if (u) return String(u); } catch(_) {}
      return "";
    }
    function getSid(){
      try { return String(new URLSearchParams(location.search).get("sid") || ""); } catch(_) { return ""; }
    }

    /* ===== –ü–æ–¥—Å–∫–∞–∑–∫–∞ (–∫–∞–∫ –±—ã–ª–æ) ===== */
    const hint   = document.getElementById('hint');
    const hintOk = document.getElementById('hintOk');

    const HINT_VER          = 'v3';
    const KEY_LAST_SHOWN    = 'yuvia_hint_last_' + HINT_VER; // YYYY-MM-DD
    const KEY_FAILS         = 'yuvia_hint_fails_' + HINT_VER;
    const FAILS_THRESHOLD   = 2;
    const NO_SELECT_TIMEOUT = 15000;

    function todayStr(){
      const d = new Date(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${m}-${day}`;
    }
    function getInt(k){ return Number(localStorage.getItem(k) || 0); }
    function setInt(k,v){ localStorage.setItem(k, String(v)); }
    function showHint(){ hint.style.display='flex'; }
    function closeHint(){ hint.style.display='none'; localStorage.setItem(KEY_LAST_SHOWN, todayStr()); localStorage.removeItem(KEY_FAILS); }
    function incFail(){ setInt(KEY_FAILS, getInt(KEY_FAILS)+1); }
    function shouldShowHint(){
      const last = localStorage.getItem(KEY_LAST_SHOWN);
      const fails = getInt(KEY_FAILS);
      if (!last) return true;
      if (last !== todayStr()) return true;
      if (fails >= FAILS_THRESHOLD) return true;
      return false;
    }
    if (shouldShowHint()) showHint();
    hintOk.onclick = closeHint;

    document.addEventListener('visibilitychange', () => {
      if (document.hidden && !window.selectedPlace) incFail();
    });
    setTimeout(() => { if (!window.selectedPlace) incFail(); }, NO_SELECT_TIMEOUT);

   // —Ç–æ—á–Ω—ã–π ¬´–¥–æ–º–æ–≤–æ–π¬ª –æ–±—Ä–∞—Ç–Ω—ã–π –≥–µ–æ–∫–æ–¥ —á–µ—Ä–µ–∑ REST (kind=house)
async function yaReverseHouse(lat, lon) {
  const url = 'https://geocode-maps.yandex.ru/1.x/?format=json'
    + '&lang=ru_RU'
    + '&kind=house'
    + '&results=5'
    + '&geocode=' + encodeURIComponent(`${lon},${lat}`)
    + '&apikey=f08ffb69-0b44-40a1-a11c-4980f7e574b6';

  try{
    const r = await fetch(url);
    const j = await r.json();
    const fm = (((j.response||{}).GeoObjectCollection||{}).featureMember)||[];
    if (!fm.length) return null;

    // –≤–æ–∑—å–º—ë–º –ø–µ—Ä–≤—ã–π —Ç–æ—á–Ω—ã–π/–Ω–∞–∏–±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π
    let pick = null, bestPrec = -1;
    const precOrder = { 'exact':4, 'number':3, 'entrance':3, 'street':2, 'near':1, 'other':0 };
    for (const m of fm) {
      const go = (m.GeoObject||{});
      const md = ((go.metaDataProperty||{}).GeocoderMetaData)||{};
      const p  = String(md.precision||'other').toLowerCase();
      const sc = precOrder[p] ?? 0;
      if (sc > bestPrec) { bestPrec = sc; pick = { go, md }; }
    }
    if (!pick) return null;

    const comp = (((pick.md.Address||{}).Components)||[]);

    return {
      kind:      String(pick.md.kind||''),
      name:      String(pick.go.name||''),  // –∏–Ω–æ–≥–¥–∞ ¬´–ö–æ—Ä–ø—É—Å ‚Ä¶¬ª
      text:      String(pick.md.text||''),  // –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å —Å—Ç—Ä–æ–∫–æ–π
      precision: String(pick.md.precision||''),
      components: comp,                     // –º–∞—Å—Å–∏–≤ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —á–∞—Å—Ç–µ–π –∞–¥—Ä–µ—Å–∞
      raw:       pick
    };
  }catch(_){ return null; }
}

// —Å–æ–±–∏—Ä–∞–µ–º ¬´–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤¬ª —Ä—è–¥–æ–º —á–µ—Ä–µ–∑ JS API (—Ç–∏–ø/–∏–º—è/–¥–∏—Å—Ç–∞–Ω—Ü–∏—è)
async function yaNearbyCandidates(coords, limit = 20) {
  const res = await ymaps.geocode(coords, { results: limit });
  const arr = [];
  res.geoObjects.each(obj => {
    try{
      const md   = obj.properties.get('metaDataProperty')?.GeocoderMetaData || {};
      const name = (obj.properties.get('name') || '').toString();
      const text = (obj.properties.get('text') || '').toString();
      const kind = String(md.kind || '').toLowerCase();
      const c    = obj.geometry?.getCoordinates?.() || coords;
      const dist = ymaps.coordSystem.geo.getDistance(coords, c);
      arr.push({ name, text, kind, dist: isFinite(dist)?Math.round(dist):null, coords:c });
    }catch(_){}
  });
  // –±–ª–∏–∂–Ω–∏–µ –∏ ¬´–ø–æ –¥–µ–ª—É¬ª –ø–æ–¥–Ω–∏–º–µ–º –ø–æ —Å–ø–∏—Å–∫—É –∫–ª—é—á–µ–≤—ã—Ö
  const KW = ['–º—É–∑–µ–π','–≥–∞–ª–µ—Ä','—Ç–µ–∞—Ç—Ä','–ø–∞–º—è—Ç–Ω–∏–∫','–º–æ–Ω—É–º–µ–Ω—Ç','—É—Å–∞–¥—å–±','–∫—Ä–µ–º–ª—å','—Å–æ–±–æ—Ä','—Ö—Ä–∞–º','–¥–≤–æ—Ä–µ—Ü','–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫'];
  arr.sort((a,b) => {
    const ka = KW.some(k => (a.name+a.text).toLowerCase().includes(k)) ? 0 : 1;
    const kb = KW.some(k => (b.name+b.text).toLowerCase().includes(k)) ? 0 : 1;
    if (ka !== kb) return ka - kb;
    const da = (a.dist ?? 1e9), db = (b.dist ?? 1e9);
    return da - db;
  });
  return arr;
}

// –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑–æ–ª–≤–µ—Ä: –∞–¥—Ä–µ—Å –¥–æ–º–∞ + –ª—É—á—à–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç; –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤ extra
async function resolveYandexPOI(coords) {
  const [lat, lon] = coords;

  // A) —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å (–¥–æ–º/–≤—Ö–æ–¥)
  const house = await yaReverseHouse(lat, lon);

  // B) –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –≤–æ–∫—Ä—É–≥ (–ø–∞–º—è—Ç–Ω–∏–∫–∏/—É–ª–∏—Ü—ã/–ø–ª–æ—â–∞–¥–∏ –∏ —Ç.–¥.)
  let candidates = [];
  try { candidates = await yaNearbyCandidates(coords, 25); } catch(_) {}

  // –≥–ª–∞–≤–Ω—ã–π ¬´–ª–µ–π–±–ª¬ª –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏:
  // - –µ—Å–ª–∏ —É –¥–æ–º–∞ precision >= number ‚Äî –±–µ—Ä—ë–º –∞–¥—Ä–µ—Å –∫–∞–∫ title (—Ç–æ—á–∫–∞ –∏–º–µ–Ω–Ω–æ –≤ –∑–¥–∞–Ω–∏–∏)
  // - –∏–Ω–∞—á–µ –±–µ—Ä—ë–º –±–ª–∏–∂–∞–π—à–µ–≥–æ ¬´–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ¬ª –∫–∞–Ω–¥–∏–¥–∞—Ç–∞; fallback ‚Äî ¬´–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ¬ª
  let title = '–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ';
  let address = '';

  const precGood = new Set(['exact','number','entrance']);
  if (house && precGood.has(String(house.precision||'').toLowerCase())) {
    title   = house.name || '–ó–¥–∞–Ω–∏–µ';
    address = house.text || '';
  } else if (candidates.length) {
    title   = candidates[0].name || '–û–±—ä–µ–∫—Ç —Ä—è–¥–æ–º';
    address = candidates[0].text || '';
  }

  return {
    name:    title || '–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ',
    address: address || '',
    lat, lon,
    // –±–æ–≥–∞—Ç–æ —É–ø–∞–∫—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    _extra: {
      y_house: house,           // kind/precision/components/‚Ä¶
      y_nearby: candidates      // –º–∞—Å—Å–∏–≤ {name,text,kind,dist,coords}
    }
  };
}


    /* ===== –ö–∞—Ä—Ç–∞ ===== */
    let map, selectedPlace = null, mainBound = false;

    ymaps.ready(() => {
      map = new ymaps.Map("map", { center: [55.751244, 37.618423], zoom: 12, controls: [] });

      // –ü–æ–∏—Å–∫
      const searchControl = new ymaps.control.SearchControl({ provider: 'yandex#search' });
      map.controls.add(searchControl);

      // –ö–Ω–æ–ø–∫–∞-–ø–æ–¥—Å–∫–∞–∑–∫–∞ (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∞, —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞)
      const iosTop = (window.Telegram?.WebApp?.platform === 'ios') ? 52 : 10;
      const helpControl = new ymaps.control.Button({
        data: { content: ' ? ' },
        options: { selectOnClick: false, maxWidth: 40 }
      });
      map.controls.add(helpControl, { position: { top: iosTop, right: 10 } });
      helpControl.events.add('click', showHint);

      // –¶–µ–Ω—Ç—Ä –ø–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–µ—Å–ª–∏ –¥–∞—Å—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
      try {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => map.setCenter([pos.coords.latitude, pos.coords.longitude], 13),
            _ => {}, { enableHighAccuracy: true, timeout: 3000 }
          );
        }
      } catch(_) {}

      // 1) –¢–∞–ø –ø–æ –∫–∞—Ä—Ç–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–≤—Ä–∏—Å—Ç–∏–∫—É (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
      map.events.add("click", async (e) => {
        const c = e.get("coords");
        selectedPlace = await resolveYandexPOI(c);
        drawPin(selectedPlace.lat, selectedPlace.lon, selectedPlace.name);
        ensureMainButton();
      });

      // 2) –í—ã–±–æ—Ä –∏–∑ –ø–æ–∏—Å–∫–∞ ‚Üí –ë–ï–ó –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞: –±–µ—Ä—ë–º –ø–æ–ª—è –ø—Ä—è–º–æ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      searchControl.events.add("resultselect", (e) => {
        const i   = e.get("index");
        const arr = searchControl.getResultsArray();
        const obj = arr[i]; if (!obj) return;

        const p    = obj.properties;
        const name = (p.get('name') || p.get('text') || '–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ').toString();
        // —É –ø–æ–∏—Å–∫–∞ –æ–±—ã—á–Ω–æ –µ—Å—Ç—å –∏ name, –∏ text: name ‚Äî –∫—Ä–∞—Ç–∫–æ, text ‚Äî –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å/–æ–ø–∏—Å–∞–Ω–∏–µ
        const addr = (p.get('text') || p.get('description') || '').toString();
        const c    = obj.geometry.getCoordinates();

        selectedPlace = { name, address: addr, lat: c[0], lon: c[1] };
        drawPin(c[0], c[1], name);
        ensureMainButton();
      });
    });

    function drawPin(lat, lon, title){
      map.geoObjects.removeAll();
      map.geoObjects.add(new ymaps.Placemark([lat, lon], { balloonContent: title || '' }));
    }

    function ensureMainButton(){
      try{
        tg.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ");
        tg.MainButton.show(); tg.MainButton.enable();
        if (!mainBound){
          mainBound = true;
          Telegram.WebApp.MainButton.onClick(onChoose);
        }
      }catch(_){}
    }

    /* ===== –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Worker (‚Üí GAS) ===== */
    function buildPayload(){
  return {
    secret:  BOT_SECRET,
    action:  "guide_save_place",
    user_id: getUserId(),
    sid:     getSid(),
    lat:     Number(selectedPlace?.lat ?? 0),
    lon:     Number(selectedPlace?.lon ?? 0),
    title:   selectedPlace?.name    || "",
    address: selectedPlace?.address || "",
    source:  "webapp",
    extra:   selectedPlace?._extra || null   // ‚Üê –∫–ª–∞–¥—ë–º –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
  };
}
    async function postJsonWithFallback(url, data){
      try{
        await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(data) });
      }catch(_){
        // fallback ¬´–ø–∏–∫—Å–µ–ª—å¬ª ‚Äì –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —É—Ö–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ –¥–∞–∂–µ –ø—Ä–∏ —Å—Ç—Ä–∞–Ω–Ω–æ–π —Å–µ—Ç–∏
        const qs = new URLSearchParams(Object.entries(data).map(([k,v])=>[k, typeof v==='object'?JSON.stringify(v):String(v)]));
        const img = new Image();
        window.__yuvia_last_pixel__ = img;
        img.src = url + "?" + qs.toString() + "&cb=" + Date.now();
        await new Promise(r => setTimeout(r, 800)); // –∫–æ—Ä–æ—Ç–∫–∞—è —Ñ–æ—Ä—Ç–æ—á–∫–∞
      }
    }

    async function onChoose(){
      if (!getUserId()){ try{ tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id. –û—Ç–∫—Ä–æ–π —Å—Å—ã–ª–∫—É —Å ?id={{id}}"); }catch(_){} return; }
      if (!selectedPlace){ try{ tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ"); }catch(_){} return; }

      try{
        tg?.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶"); tg?.MainButton.disable();
        await postJsonWithFallback(PROXY_URL, buildPayload());
      }finally{
        try{ tg.close(); }catch(_){}
      }
    }
  </script>
</body>
</html>





