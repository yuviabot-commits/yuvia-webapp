<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>YuviaBot Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map { width:100%; height:100%; margin:0; padding:0; }
  </style>
  <!-- Яндекс.Карты -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=f08ffb69-0b44-40a1-a11c-4980f7e574b6"></script>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    // === Константы ===
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();

    // наш прокси-воркер (вместо прямого script.google.com)
    const PROXY_URL = "https://yuvia-proxy.yuviabot.workers.dev/";

    // Секрет и действие для GAS
    const BOT_SECRET = "8d7f3f2e2a6d44b5aeb4caa7f924c8f9";

    // Берём id из query (?id= / ?user_id= / ?contact_id=), иначе — из Telegram initData
    function getUserId() {
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get("id") || qs.get("user_id") || qs.get("contact_id");
      if (fromQS) return String(fromQS);
      try {
        const fromTG = tg?.initDataUnsafe?.user?.id;
        if (fromTG) return String(fromTG);
      } catch(_) {}
      return "";
    }

    let map, selectedPlace = null, mainBound = false;

    // === Инициализация карты ===
    ymaps.ready(() => {
      map = new ymaps.Map("map", {
        center: [55.751244, 37.618423],
        zoom: 12,
        controls: []
      });

      const searchControl = new ymaps.control.SearchControl({ provider: 'yandex#search' });
      map.controls.add(searchControl);

      // Клик по карте
      map.events.add("click", (e) => {
        const c = e.get("coords");
        selectedPlace = { name: "Выбранная точка", address: "", lat: c[0], lon: c[1] };
        redraw(c, "Выбрано здесь");
        ensureMainButton();
      });

      // Выбор из поиска
      searchControl.events.add("resultselect", (e) => {
        const i = e.get("index");
        const res = searchControl.getResultsArray();
        const obj = res[i];
        if (!obj) return;
        const c = obj.geometry.getCoordinates();
        selectedPlace = {
          name: obj.properties.get("name") || "Объект",
          address: obj.properties.get("description") || "",
          lat: c[0], lon: c[1]
        };
        redraw(c, selectedPlace.name);
        ensureMainButton();
      });
    });

    function redraw(coords, balloon) {
      map.geoObjects.removeAll();
      map.geoObjects.add(new ymaps.Placemark(coords, { balloonContent: balloon || "" }));
    }

    function ensureMainButton() {
      tg.MainButton.setText("Выбрать место");
      tg.MainButton.show();
      tg.MainButton.enable();
      if (!mainBound) {
        mainBound = true;
        Telegram.WebApp.MainButton.onClick(onChoose);
      }
    }

    function onChoose() {
      const uid = getUserId();
      if (!uid) {
        try { Telegram.WebApp.showAlert("Не удалось получить user_id. Открой ссылку с ?id={{id}}"); } catch(_) {}
        return;
      }
      if (!selectedPlace) {
        try { Telegram.WebApp.showAlert("Сначала выбери точку на карте"); } catch(_) {}
        return;
      }

      // Формируем payload для GAS
      const payload = {
        secret:  BOT_SECRET,
        action:  "save_place",
        user_id: uid,
        title:   selectedPlace.name || "",
        address: selectedPlace.address || "",
        lat:     String(selectedPlace.lat || ""),
        lon:     String(selectedPlace.lon || ""),
        ts:      String(Date.now())
      };

      // Самый «пробивной» способ в webview: GET-пиксель на ПРОКСИ
      const qs = new URLSearchParams(payload);
      (new Image()).src = PROXY_URL + "?" + qs.toString();

      // Закрываем окно через ~300 мс, чтобы запрос успел уйти
      setTimeout(() => { try { Telegram.WebApp.close(); } catch(_) {} }, 300);
    }
  </script>
</body>
</html>

